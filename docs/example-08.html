<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Example 8: Stroke Units - command-line-canvas</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
    <nav>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="example-07.html">Previous</a></li>
            <li><a href="example-09.html">Next</a></li>
        </ul>
    </nav>
    <h1>Example 8: Stroke&nbsp;Units</h1>
    <p>Three circles demonstrating different stroke unit behaviors with scale=2.</p>
</header>
<p>
    This example shows how <code>strokeUnit</code> affects stroke rendering:
</p>
<ul>
    <li><strong>pixel</strong> (left): Stroke width stays constant in pixels</li>
    <li><strong>shape</strong> (middle): Stroke scales with shape and world</li>
    <li><strong>world</strong> (right): Stroke scales with world, and ignores shape scale</li>
</ul>
<pre id="output"></pre>

<!-- If running on localhost or local network and path includes "/docs/", add
     .w4-is-dev class to body, show #w4-dev-badge, and set W4.isDev to true. -->
<script>!function($body, hostname){
var W4 = window.W4 = window.W4 || {};
var is = W4.isDev = (/^(?:192\.168|10\.)|\.local$/.test(hostname)
    || (['::1', '', '127.0.0.1', 'localhost'].indexOf(hostname) > -1))
    && location.pathname.indexOf('/docs/') > -1;
$body.classList[is ? 'add' : 'remove']('w4-is-dev');
if (is) $body.appendChild(document.createElement('div')).id = 'w4-dev-badge';
}(document.body, location.hostname)</script>

<script type="module">
    const base = '../src/models/'; // shared path to source code models
    const Ms = ['Canvas', 'Color', 'Pixel', 'Primitive', 'Shape']; // model names
    const { Canvas, Color, Pixel, Primitive, Shape } = window.W4?.isDev
        ? await (async () => // if dev mode, import each model...
            (await Promise.all(Ms.map(M => M.toLowerCase()) // ...in parallel...
                .map(m => import(`${base}${m}/${m}.js`))) // ...from source...
            ).reduce((acc, js, i) => { acc[Ms[i]] = js[Ms[i]]; return acc }, {})
        )()
        : await import('./command-line-canvas.js'); // ...otherwise use build

    // Create an 80x48 pixel canvas with dark grey background.
    const greyBg = new Pixel(40, 40, 40);
    const canvas = new Canvas(greyBg, 80, 48);

    // Create colors.
    const cyan = new Color(0, 255, 255, 255);
    const magenta = new Color(255, 0, 255, 255);
    const yellow = new Color(255, 255, 0, 255);
    const white = new Color(255, 255, 255, 255);
    const transparent = new Color(0, 0, 0, 0);

    // Create a circle primitive at the center.
    const circlePrim = new Primitive(
        null,            // debugPrimitiveAabb
        'no-flip',
        'union',         // joinMode
        'circle',        // kind
        0,               // rotate
        1,               // scale
        { x: 0, y: 0 }   // translate (center of world-space)
    );

    // Create three shapes with different strokeUnit values.
    // All have scale=2 and strokeWidth=2.
    
    // Left circle: strokeUnit='pixel' - stroke stays constant 2 pixels.
    const pixelCircle = new Shape(
        'normal',        // blendMode
        null,            // debugShapeAabb
        'no-flip',
        cyan,            // ink (fill color)
        transparent,     // paper
        'all-ink',       // pattern
        0.5,             // patternRatio
        1,               // patternScale
        'pixel',         // patternUnit
        [circlePrim],    // primitives
        0,               // rotate
        2,               // scale
        white,           // strokeColor
        'center',        // strokePosition
        'pixel',         // strokeUnit (stays constant in pixels)
        2,               // strokeWidth
        { x: -3, y: 0 }  // translate (left)
    );

    // Middle circle: strokeUnit='shape' - stroke scales with shape (2px * 2 scale = 4px effective).
    const shapeCircle = new Shape(
        'normal',        // blendMode
        null,            // debugShapeAabb
        'no-flip',
        magenta,         // ink (fill color)
        transparent,     // paper
        'all-ink',       // pattern
        0.5,             // patternRatio
        1,               // patternScale
        'pixel',         // patternUnit
        [circlePrim],    // primitives
        0,               // rotate
        2,               // scale
        white,           // strokeColor
        'center',        // strokePosition
        'shape',         // strokeUnit (scales with shape and world)
        2,               // strokeWidth
        { x: 0, y: 0 }   // translate (center)
    );

    // Right circle: strokeUnit='world' - stroke in world units (2 world units).
    const worldCircle = new Shape(
        'normal',        // blendMode
        null,            // debugShapeAabb
        'no-flip',
        yellow,          // ink (fill color)
        transparent,     // paper
        'all-ink',       // pattern
        0.5,             // patternRatio
        1,               // patternScale
        'pixel',         // patternUnit
        [circlePrim],    // primitives
        0,               // rotate
        2,               // scale
        white,           // strokeColor
        'center',        // strokePosition
        'world',         // strokeUnit (in world units, ignores shape scale)
        2,               // strokeWidth
        { x: 3, y: 0 }   // translate (right)
    );

    // Add the shapes to the canvas.
    canvas.addShape(pixelCircle);
    canvas.addShape(shapeCircle);
    canvas.addShape(worldCircle);

    // Render to truecolor ANSI and display.
    const ansiOutput = canvas.render('truecolor', 'ansi');
    document.getElementById('output').innerHTML = ansiToHtml(ansiOutput);

    // Converts truecolor ANSI to HTML.
    // "\x1B[48;2;11;22;33m\x1B[38;2;44;55;66m▄" becomes:
    // "<b style="background:rgb(11,22,33);color:rgb(44,55,66)">▄</b>".
    // "[0m\n" becomes just a newline.
    function ansiToHtml(ansi) {
        // Split into lines.
        const lines = ansi.split('[0m\n');
        let html = [];
        for (let i = 0; i < lines.length; i++) {
            // Split using the "▄" character.
            const pixelPairs = lines[i].split('▄');
            for (let j = 0; j < pixelPairs.length - 1; j++) { // -1 to skip last empty
                const pair = pixelPairs[j];
                // Each pair defines the background and foreground colors.
                const [bgRaw, fgRaw] = pair.split('\x1B[38;2;');
                const bgRGB = bgRaw.slice(7, -1).split(';'); // the 7 chars in "\x1B[48;2;" and the 1 char "m"
                const fgRGB = fgRaw.slice(0, -1).split(';'); // -1 to remove the trailing "m"
                const [br,bg,bb] = bgRGB;
                const [fr,fg,fb] = fgRGB;
                const el =
                    `<b style="background:rgb(${br},${bg},${bb});` +
                    `color:rgb(${fr},${fg},${fb})">` +
                    '▄</b>';
                html.push(el);
            }
            html.push('\n');
        }
        return html.join('');
    }
</script>
</body>
</html>

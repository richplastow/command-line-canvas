<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Example 2: Right Triangles - command-line-canvas</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
    <nav>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="example-01.html">Previous</a></li>
            <li><a href="example-03.html">Next</a></li>
        </ul>
    </nav>
    <h1>Example 2: Right Triangles</h1>
    <p>Four right triangles with light-magenta fill and navy outline on a
        light-aqua background, each using a different `flip` and `rotate` value.
        AABBs for Primitives and the Shape are shown with red and blue
        translucent boxes.</p>
</header>
<p>Copies 'buffer' data into a canvas element.</p>
<canvas id="output"></canvas>

<!-- If running on localhost or local network and path includes "/docs/", add
     .w4-is-dev class to body, show #w4-dev-badge, and set W4.isDev to true. -->
<script>!function($body, hostname){
var W4 = window.W4 = window.W4 || {};
var is = W4.isDev = (/^(?:192\.168|10\.)|\.local$/.test(hostname)
    || (['::1', '', '127.0.0.1', 'localhost'].indexOf(hostname) > -1))
    && location.pathname.indexOf('/docs/') > -1;
$body.classList[is ? 'add' : 'remove']('w4-is-dev');
if (is) $body.appendChild(document.createElement('div')).id = 'w4-dev-badge';
}(document.body, location.hostname)</script>

<script type="module">
    const base = '../src/models/'; // shared path to source code models
    const Ms = ['Canvas', 'Color', 'Pixel', 'Primitive', 'Shape']; // model names
    const { Canvas, Color, Pixel, Primitive, Shape } = window.W4?.isDev
        ? await (async () => // if dev mode, import each model...
            (await Promise.all(Ms.map(M => M.toLowerCase()) // ...in parallel...
                .map(m => import(`${base}${m}/${m}.js`))) // ...from source...
            ).reduce((acc, js, i) => { acc[Ms[i]] = js[Ms[i]]; return acc }, {})
        )()
        : await import('./command-line-canvas.js'); // ...otherwise use build

    // Create an 80x48 pixel canvas with light-blue background.
    const lightBlue = new Pixel(173, 216, 230);
    const canvas = new Canvas(lightBlue, 800, 480);

    // Create colors.
    const lightMagenta = new Color(255, 128, 255, 1);
    const navy = new Color(0, 0, 128, 1);
    const transparent = new Color(0, 0, 0, 0);

    // Four triangle-right primitives positioned in a 2x2 grid.
    const pTopLeft = new Primitive(
        new Color(255, 0, 0, 0.3), // debugPrimitiveAabb
        'flip-x-and-y',  // flip
        'union',         // joinMode
        'triangle-right',
        0.785398163,     // rotate 45 degrees
        1,             // scale
        { x: -3, y: -2 } // translate
    );

    const pTopRight = new Primitive(
        new Color(255, 0, 0, 0.3), // debugPrimitiveAabb
        'flip-x',
        'union',
        'triangle-right',
        -0.1,
        1.1,
        { x: 3, y: -2 }
    );

    const pBottomLeft = new Primitive(
        new Color(255, 0, 0, 0.3), // debugPrimitiveAabb
        'flip-y',
        'union',
        'triangle-right',
        0.3,
        1,
        { x: -3, y: 2 }
    );

    const pBottomRight = new Primitive(
        new Color(255, 0, 0, 0.3), // debugPrimitiveAabb
        'no-flip',
        'union',
        'triangle-right',
        0,
        1,
        { x: 3, y: 2 }
    );

    const shape = new Shape(
        'normal',            // blendMode
        new Color(0, 0, 255, 0.3), // debugPrimitiveAabb
        'no-flip',
        lightMagenta,        // ink
        transparent,         // paper
        'all-ink',           // pattern
        0.5,                 // patternRatio
        1,                   // patternScale
        'pixel',             // patternUnit
        [pTopLeft, pTopRight, pBottomLeft, pBottomRight], // primitives
        0,                   // rotate
        1,                   // scale
        navy,                // strokeColor
        'outside',           // strokePosition
        'world',             // strokeUnit
        0.1,                 // strokeWidth (world units)
        { x: 0, y: 0 }       // translate
    );

    canvas.addShape(shape);

    // Render to the canvas element.
    const canvasElement = document.getElementById('output');
    canvasElement.width = canvas.xExtent;
    canvasElement.height = canvas.yExtent;
    const ctx = canvasElement.getContext('2d');
    const imageData = ctx.createImageData(canvas.xExtent, canvas.yExtent);
    const data = imageData.data;

    // Animate the shape rotation and rerender each frame.
    let lastTs = null;
    const rotateSpeed = 0.6; // radians per second.
    const loop = (ts) => {
        if (lastTs === null) lastTs = ts;
        const dt = (ts - lastTs) / 1000;
        lastTs = ts;

        // Update rotation and keep within 0..2pi to avoid large numbers.
        shape.rotate = (shape.rotate + rotateSpeed * dt) % (Math.PI * 2);

        // Mark the canvas as dirty, then rerender it to the buffer and copy
        // into canvas image data.
        canvas.requestUpdate();
        const pixelData = canvas.render('truecolor', 'buffer');
            data.set(pixelData);
            ctx.putImageData(imageData, 0, 0);

        // Uncomment to run the animation:
        // requestAnimationFrame(loop);
    };

    requestAnimationFrame(loop);
</script>
</body>
</html>
